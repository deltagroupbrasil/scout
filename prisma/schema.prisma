// LeapScout - Sistema de Inteligência de Leads B2B
// Prisma Schema - Multi-Tenant SaaS Version 2.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT MODEL (Multi-Tenancy)
// ============================================
model Tenant {
  id              String   @id @default(uuid())
  name            String   // Nome da empresa cliente (ex: "Magazine Luiza")
  slug            String   @unique  // URL-friendly (ex: "magazine-luiza")

  // Configuração
  isActive        Boolean  @default(true)
  plan            String   @default("basic")  // basic, pro, enterprise (placeholder para futuro)
  maxUsers        Int      @default(5)
  maxSearchQueries Int     @default(3)

  // Features habilitadas (JSON array de strings)
  // Possíveis: "dashboard", "kanban", "search", "export", "ai_insights", "contact_enrichment"
  enabledFeatures Json     @default("[\"dashboard\"]")

  // Billing
  billingEmail    String?
  contractStart   DateTime
  contractEnd     DateTime?

  // Metadados
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relações
  tenantUsers      TenantUser[]
  searchQueries    TenantSearchQuery[]
  leads            Lead[]
  notes            Note[]
  scrapeLogs       ScrapeLog[]

  @@index([slug])
  @@index([isActive])
  @@map("Tenant")
}

// ============================================
// TENANT USER (Vínculo User-Tenant com Role)
// ============================================
model TenantUser {
  id              String     @id @default(uuid())
  tenantId        String
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  role            TenantRole @default(VIEWER)
  isActive        Boolean    @default(true)

  createdAt       DateTime   @default(now())

  @@unique([tenantId, userId])  // User pode estar em múltiplos tenants, mas apenas 1x por tenant
  @@index([userId])
  @@index([tenantId])
  @@map("TenantUser")
}

// ============================================
// SUPER ADMIN (Delta Group Staff)
// ============================================
model SuperAdmin {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@map("SuperAdmin")
}

// ============================================
// USER MODEL
// ============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  isAdmin   Boolean  @default(false)  // DEPRECATED: usar TenantUser.role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 2FA (Two-Factor Authentication)
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?  // TOTP secret (encrypted)
  backupCodes      Json?    // Array de códigos de backup (encrypted)

  // Multi-Tenancy
  tenantUsers      TenantUser[]
  superAdmin       SuperAdmin?
  lastActiveTenantId String?  // Último tenant acessado

  notes            Note[]
  contactFeedbacks ContactFeedback[]
  assignedLeads    Lead[]
  searchQueries    TenantSearchQuery[]

  @@map("User")
}

// ============================================
// COMPANY MODEL
// ============================================
model Company {
  id          String    @id @default(uuid())
  name        String
  cnpj        String?   @unique
  revenue     Float?    // Faturamento anual em reais
  employees   Int?      // Número de funcionários
  sector      String?   // Setor de atuação
  location    String?   // Endereço completo
  // Website & Social Media
  website              String?
  websiteSource        String?   // claude_ai, google_search, email_domain, manual
  websiteConfidence    String?   // high, medium, low
  websiteVerifiedAt    DateTime? // Última verificação do website
  linkedinUrl          String?
  linkedinFollowers    String?   // Seguidores no LinkedIn
  instagramUrl         String?   // URL completa do Instagram
  instagramHandle      String?   // @usuario do Instagram
  instagramFollowers   String?   // Seguidores estimados
  instagramVerified    Boolean   @default(false) // Verificado via scraping
  twitterUrl           String?   // URL completa do Twitter/X
  twitterHandle        String?   // @usuario do Twitter/X
  twitterVerified      Boolean   @default(false) // Verificado via scraping
  facebookUrl          String?   // URL completa do Facebook
  facebookHandle       String?   // Handle do Facebook
  facebookVerified     Boolean   @default(false) // Verificado via scraping
  youtubeUrl           String?   // URL completa do YouTube
  youtubeHandle        String?   // Handle do YouTube
  youtubeVerified      Boolean   @default(false) // Verificado via scraping
  socialMediaSource    String?   // website_scraping, ai_search, google_search, pattern_guess
  socialMediaUpdatedAt DateTime? // Última atualização das redes sociais

  // AI Enrichment Data
  estimatedRevenue    String?  // Faixa estimada via IA (ex: "R$ 50M - R$ 100M")
  estimatedEmployees  String?  // Faixa estimada via IA (ex: "200-500")
  recentNews          Json?    // Array de notícias recentes
  upcomingEvents      Json?    // Array de eventos futuros
  eventsDetectedAt    DateTime? // Última vez que eventos foram detectados
  industryPosition    String?  // Posição no mercado (líder, challenger, etc)
  keyInsights         Json?    // Array de insights chave
  enrichedAt          DateTime? // Última vez que foi enriquecida com IA

  // Contact Enrichment Data (Nova Vida TI)
  companyPhones       Json?    // Array de telefones da empresa
  companyEmails       Json?    // Array de emails corporativos
  companyWhatsApp     String?  // WhatsApp da empresa
  partners            Json?    // Array de sócios {nome, qualificacao, telefones, emails, linkedin}
  partnersLastUpdate  DateTime? // Última atualização dos dados de sócios

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  leads       Lead[]

  @@map("Company")
}

// ============================================
// LEAD MODEL
// ============================================
model Lead {
  id              String   @id @default(uuid())

  // Multi-Tenancy
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Informações da Vaga Principal
  jobTitle        String
  jobDescription  String
  jobUrl          String
  jobPostedDate   DateTime
  jobSource       String   @default("LinkedIn")
  candidateCount  Int?     // Número de candidatos (quando disponível)

  // Vagas Adicionais da Mesma Empresa (JSON)
  relatedJobs     Json?  // Array de {title, description, url, postedDate, candidateCount}

  // Inteligência (IA Generated)
  suggestedContacts Json?  // Array de {name, role, linkedin, email, phone, source}
  triggers          Json?  // Array de strings com gatilhos de abordagem

  // CRM Status
  status          LeadStatus @default(NEW)
  priorityScore   Int        @default(0)     // Score de prioridade (0-100)

  // Atribuição (Assignment)
  assignedToId    String?   // ID do usuário responsável pelo lead
  assignedTo      User?     @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt      DateTime? // Data de atribuição

  // Metadata
  isNew           Boolean    @default(true)  // Flag para leads < 48h
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  notes            Note[]
  contactFeedbacks ContactFeedback[]

  // Índices simples
  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@index([companyId])
  @@index([assignedToId])

  // Índices compostos multi-tenant (CRITICAL para isolamento e performance)
  @@index([tenantId, status])             // Dashboard: filtrar por tenant e status
  @@index([tenantId, createdAt])          // Dashboard: leads do tenant ordenados por data
  @@index([tenantId, status, createdAt])  // Dashboard: filtrar status e ordenar por data
  @@index([tenantId, status, priorityScore])  // Dashboard: filtrar status e ordenar por prioridade
  @@index([tenantId, companyId])          // Company page: leads de uma empresa no tenant
  @@index([tenantId, assignedToId])       // User page: leads atribuídos no tenant
  @@index([tenantId, isNew, createdAt])   // Dashboard: destacar leads novos no tenant

  @@map("Lead")
}

// ============================================
// NOTE MODEL
// ============================================
model Note {
  id        String   @id @default(uuid())

  // Multi-Tenancy
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([leadId])
  @@index([createdAt])
  @@index([tenantId, leadId])  // Multi-tenant: notas de um lead no tenant
  @@map("Note")
}

// ============================================
// SCRAPE LOG MODEL
// ============================================
model ScrapeLog {
  id            String   @id @default(uuid())

  // Multi-Tenancy (opcional para logs globais de sistema)
  tenantId      String?
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  status        String   // success, error, running
  query         String   // Query usada na busca
  jobsFound     Int      @default(0)
  leadsCreated  Int      @default(0)
  errors        Json?  // Erros encontrados
  duration      Int?     // Duração em segundos
  createdAt     DateTime @default(now())

  @@index([tenantId])
  @@index([createdAt])
  @@index([tenantId, createdAt])  // Multi-tenant: logs do tenant por data
  @@map("ScrapeLog")
}

// ============================================
// ENRICHMENT CACHE MODEL
// ============================================
model EnrichmentCache {
  id          String   @id @default(uuid())
  cnpj        String   @unique

  // Dados enriquecidos
  razaoSocial String?
  nomeFantasia String?
  capitalSocial Float?
  porte       String?
  sector      String?
  website     String?

  // Metadados do cache
  success     Boolean  @default(true)
  errorMessage String?
  expiresAt   DateTime // Cache expira após 30 dias
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([cnpj])
  @@index([expiresAt])
  @@map("EnrichmentCache")
}

// ============================================
// NOVA VIDA TI USAGE MODEL
// ============================================
model NovaVidaTIUsage {
  id          String   @id @default(uuid())
  companyName String   // Nome da empresa consultada
  cnpj        String   // CNPJ consultado
  cost        Float    @default(0.06) // Custo da consulta (R$ 0.06)
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([cnpj])
  @@map("NovaVidaTIUsage")
}

// ============================================
// CONTACT FEEDBACK MODEL
// ============================================
model ContactFeedback {
  id           String   @id @default(uuid())
  leadId       String
  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId       String
  user         User     @relation(fields: [userId], references: [id])

  // Dados do contato avaliado
  contactName  String
  contactRole  String
  contactEmail String?
  contactPhone String?
  contactSource String?  // apollo, linkedin, google, website, estimated

  // Feedback
  isCorrect    Boolean  // true = ✅ correto, false = ❌ incorreto
  comment      String?  // Comentário opcional do usuário

  createdAt    DateTime @default(now())

  @@index([leadId])
  @@index([userId])
  @@index([contactSource])
  @@index([isCorrect])
  @@map("ContactFeedback")
}

// ============================================
// TENANT SEARCH QUERY MODEL (Queries de Busca por Tenant)
// ============================================
model TenantSearchQuery {
  id          String   @id @default(uuid())

  // Multi-Tenancy
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String   // Nome da query (ex: "Controllers SP", "CFOs Brasil")
  jobTitle    String   // Termo de busca (ex: "Controller", "CFO", "Gerente Financeiro")
  location    String   // Localização (ex: "São Paulo, SP", "Brasil")
  maxCompanies Int     @default(20) // Limite de empresas por busca
  isActive    Boolean  @default(true) // Ativa/Desativada

  // Controle Delta Group
  isLocked    Boolean  @default(true)  // true = query fixa (configurada na venda), false = editável

  // Metadados
  createdById String   // Usuário que criou (geralmente Super Admin da Delta Group)
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  lastUsedAt  DateTime? // Última vez que foi executada
  usageCount  Int      @default(0) // Quantas vezes foi usada

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([isActive])
  @@index([createdById])
  @@index([lastUsedAt])
  @@index([tenantId, isActive])  // Multi-tenant: queries ativas do tenant
  @@map("TenantSearchQuery")
}

// ============================================
// ENUMS
// ============================================
enum LeadStatus {
  NEW         // Novo - Lead recém captado
  CONTACTED   // Contatado - Primeiro contato realizado
  QUALIFIED   // Qualificado - Lead com potencial confirmado
  DISCARDED   // Descartado - Lead sem fit

  @@map("LeadStatus")
}

enum TenantRole {
  ADMIN    // Acesso total ao tenant (gerenciar usuários, queries, leads)
  MANAGER  // Pode gerenciar leads e atribuições (sem gerenciar usuários)
  USER     // Pode ver e atualizar leads atribuídos a ele
  VIEWER   // Apenas leitura (visualizar leads)

  @@map("TenantRole")
}
